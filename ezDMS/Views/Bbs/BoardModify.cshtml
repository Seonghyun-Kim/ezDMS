@{
    if (Request.Headers["X-PJAX"] != null)
    {
        Layout = null;
    }
    else
    {
        Layout = "~/Views/Shared/_Layout.cshtml";
    }
}

<style type="text/css">
.dropzone .dz-preview .dz-image {
    width: 124px !important;
    height: 84px !important;
}

 .dz-preview.dz-file-preview .dz-details .dz-size {
     display:none;
     font-size:12px;
 }
.dropzone .dz-message {
    margin-top :45px;
}

</style>


<div id="boardContent">
    <div id ="btns" style="display : flex; margin-left:10px;">
        <button id ="btnGoList" style="margin-bottom:5px;">목록으로</button>
    </div>
    <input type = "hidden" id = "hid_bbs_idx" value ="@ViewBag.bbsContentsModel.bbs_idx" />
    <input type="hidden" id="hid_bbs_category" value="@ViewBag.bbsContentsModel.bbs_category" />
    <table class="titleGrid">
        <tr>
            <th>제목</th>
            <td><input type="text" id="txtBbsTitle" style="width: 100%;" value="@ViewBag.bbsContentsModel.bbs_title" /></td>
            <th>작성자</th>
            <td>@ViewBag.bbsContentsModel.create_us_nm</td>
            <th>작성일</th>
            <td>@ViewBag.bbsContentsModel.create_dt</td>
        </tr>
        <tr>
            <th>첨부파일</th>
            <td colspan="6">
                <form id="frmLocalfile" action="/file-upload" class="dropzone" style="height:50px;"></form>
            </td>
        </tr>
        <tr>
            <th>내용</th>
            <td colspan="6" style="min-height:200px;height:400px;vertical-align:top;">
                <textarea id="editor">  @Html.Raw(ViewBag.bbsContentsModel.bbs_content)</textarea>
            </td>
        </tr>
    </table>

    <div id="btns" style="display:flex; margin-left:10px;">
        <button id="btnBbsModi" style="margin-bottom:5px; margin-right:10px;">완료</button>
    </div>
</div>


<script type="text/javascript">
    $("#lbLocation").text("게시판 - 게시글 수정");
    var bbsSource =
    {
        datatype: "json",
        datafields: [
            { name: 'bbs_idx' },
            { name: 'bbs_category' },
            { name: 'bbs_title' },
            { name: 'bbs_content' },
            { name: 'create_us_nm' },
            { name: 'create_datetime' },
        ],
        id: 'bbs_idx',
        localdata: null
    };

    var bbsFileSource =
    {
        datatype: "json",
        datafields: [
            { name: 'bbs_file_idx' },
            { name: 'bbs_idx' },
            { name: 'file_org_nm' },
            { name: 'file_conv_nm' },
        ],
        id: 'bbs_file_idx',
        localdata: null
    };

    var oDropzone = null;

        Dropzone.options.frmLocalfile = {
            url: '@Url.Action("SetBoardContents", "Bbs")',
            params: {"bbs_idx": $('#hid_bbs_idx').val(), "bbs_category" : $("input[name=category]:checked").val() , "bbs_title" :  $("#txtBbsTitle").val() , "bbs_content":  $("#editor").val()}, 
            addRemoveLinks: true,

            autoProcessQueue: false,
            paralleChunkUploads: true,
            uploadMultiple: true,
            thumbnailWidth: 50,
            thumbnailHeight:50,
            parallelUploads: 20,
            maxFiles: 20,
            maxFilesize: 2048,
            method: 'post',

            init: function () { //초기동작initial
                oDropzone = this;

                var fileList = @Html.Raw(Json.Encode(ViewBag.bbsFileModel));

                var mockFile = {};
               
               
                var BbsModify = document.querySelector('#btnBbsModi');

                BbsModify.addEventListener("click", function () {

                    if (oDropzone.files.length == 0) {
                        oDropzone._uploadData([{ upload: { filename: '' } }], [{ filename: '', name: '', data: new Blob() }]);
                    }
                    oDropzone.processQueue();
                });

                if (fileList.length > 0)
                {
                    fileList.forEach(function (item) {
                        mockFile = {
                            name : item.file_org_nm,
                        }
                        oDropzone.emit("addedfile", mockFile);  
                        oDropzone.emit("complete", mockFile);
                        //oDropzone.files.push(file);
                         oDropzone.files.push(mockFile);
                    });
                    
                }

                this.on("sending", function (file, xhr, formData) {
                    //formData.append("category", $("div [name='category'] : checked").val() );
                    formData.append("bbs_idx", $('#hid_bbs_idx').val());
                    formData.append("bbs_category", $('#hid_bbs_category').val());
                    formData.append("bbs_title", $("#txtBbsTitle").val());
                    formData.append("bbs_content", $("#editor").val());

                    console.log(formData);
                });
                
                this.on("removedfile", function (file) {

                    // Only files that have been programmatically added should
                    // have a url property.

                    if (file.url && file.url.trim().length > 0) {
                        $("<input type='hidden'>").attr({
                            id: 'DeletedImageUrls',
                            name: 'DeletedImageUrls'
                        }).val(file.url).appendTo('#image-form');
                    }
                    

                });

                this.on("complete", function (data) {
                    if (this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0) {
                        if (data.xhr != undefined) {
                            if (data.isError) {
                                alert(data.resultMessage);
                                console.log(data.resultDescription);
                                return false;
                            }
                            this.removeAllFiles(true);

                            var IDX = eval("(" + data.xhr.responseText + ")");
                            location.href = "/Bbs/BoardView?bbs_idx=" + IDX.bbs_idx;
                        }
                    }
                });

                
            }
        }

    $(document).ready(function () {

        $('#btnGoList').click(function () {
            location.href = "/Bbs/BoardList";
        });

        $('#editor').jqxEditor({
            height: "400px",
            width: "100%",
            tools: 'bold italic underline | left center right'
        });


    });
    //function BbsModify() {
    //    var printBbs = function (res) {
    //        location.href = "/Bbs/BoardView?bbs_idx=" + res.bbs_idx;
    //       
    //    }

    //    param = {};

    //    param.bbs_category = $('#hid_bbs_category').val();
    //    param.bbs_idx = $('#hid_bbs_idx').val();
    //    param.bbs_title = $('#txtBbsTitle').val();
    //    param.bbs_content = $("#editor").val();

    //    GetCommData("/Bbs/SetBoardContents", param, printBbs);
    //}
</script>
